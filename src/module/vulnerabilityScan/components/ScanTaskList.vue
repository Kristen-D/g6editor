<template>
<div class="">
  <!-- {{checkList}} {{tableId}} -->
  <el-table :data="defConf.tableData" style="width: 100%" @selection-change="handleSelectionChange">

    <el-table-column type="selection">
    </el-table-column>
    <el-table-column label="任务名称" align="center">
      <template scope="scope">
        <el-button type="text" @click="getVscanHistory(scope.row)">
          {{scope.row.taskName}}
        </el-button>
      </template>
    </el-table-column>
    <el-table-column prop="scanTarget" label="扫描目标" align="center">
    </el-table-column>
    <el-table-column prop="scanStrategyName" label="扫描策略" align="center">
    </el-table-column>
    <el-table-column prop="frequency" label="执行频率" align="center">
    </el-table-column>
    <el-table-column prop="scanTypeName" label="扫描类型" align="center">
    </el-table-column>
    <el-table-column prop="scanProtocol" label="扫描协议" align="center">
    </el-table-column>

    <!-- <el-table-column :prop="key" :label="value" v-for="(value, key) in columnList" :sortable="key==='assetCode'" align="center">
    </el-table-column> -->
    <el-table-column label="操作" align="center" width="180">
      <template scope="scope">

        <el-button type="text" @click="handleDelete(scope.$index, scope.row)" style="color:#00a0fe; margin-right:17px;">删除</el-button>
        <span style="color: #F3F3F3">|</span>
        <el-button type="text" @click="handleEdit(scope.$index, scope.row)" style="color:#00a0fe; margin-left:17px;">编辑</el-button>

      </template>
    </el-table-column>

    <div slot="empty" >
      <div class="" v-if="(!defConf.tableData || defConf.tableData.length === 0) && 'loaded' === defConf.loading">
        <i class="el-icon-document"></i> 没有相关数据！
      </div>

      <div class="" v-if="'wrong' === defConf.loading">
        <i class="el-icon-warning"></i> 数据加载错误！ 点击
        <el-button type="text" @click="refresh">刷新</el-button>
      </div>

      <div class="" v-if="'load' === defConf.loading">
        <i class="el-icon-loading"></i> 正在读取数据，请稍后...
      </div>
    </div>

  </el-table>

  <el-pagination class=" float-r page-location" @current-change="handleCurrentChange" :page-size="defConf.pageSize" :current-page="defConf.pageIndex" layout="total, prev, pager, next, jumper" :total="defConf.total">
  </el-pagination>

  <el-dialog title="漏扫历史" :visible.sync="dialogTableVisible">
    <el-table :data="vscanHistoryData">
      <el-table-column property="taskId" label="历史ID" width="100"  align="center"></el-table-column>
      <el-table-column property="starttimestamp" label="开始时间" width="180" align="center"></el-table-column>
      <el-table-column property="endtimestamp" label="结束时间" width="180"  align="center"></el-table-column>
      <el-table-column label="扫描状态" width="200"  align="center">
        <template scope="scope">
          <span v-if="scope.row.status===1">未扫描</span>
          <span v-else-if="scope.row.status===2">扫描中</span>
          <span v-else-if="scope.row.status===3">已扫描</span>
          <span v-else-if="scope.row.status===4">暂停扫描</span>
          <span v-else-if="scope.row.status===5">等待扫描</span>
          <span v-else="scope.row.status===6">扫描错误</span>
        </template>
      </el-table-column>
      <el-table-column label="报告状态"  align="center">
        <template scope="scope">
          <span v-if="scope.row.reportcreatestatus===4">未生成</span>
          <span v-else-if="scope.row.reportcreatestatus===0">正在生成</span>
          <el-button type="text" @click="getReport(scope.row.path)" v-else-if="scope.row.reportcreatestatus===1">
            点击下载报告
          </el-button>
          <span v-else-if="scope.row.reportcreatestatus===2">等待生成</span>
          <span v-else="scope.row.reportcreatestatus===3">生成失败</span>

        </template>
      </el-table-column>
    </el-table>
  </el-dialog>

</div>
</template>

<script>
export default {
  components: {},
  props: ['checkList', 'id'],
  computed: {
    columnList: function() {
      if (this.checkList.length > 0) {
        let ob = "{";
        for (let x in this.checkList) {
          ob = ob + this.checkList[x] + ",";
        }
        let nob = ob.substring(0, ob.length - 1) + "}";
        return JSON.parse(nob);
      } else {
        return {};
      }

    }
  },
  data() {
    return {
      defConf: {},
      dialogTableVisible: false,
      vscanHistoryData: []
    }
  },
  methods: {
    getReport(path) {
      window.location.href='/'+path;
    },
    async getVscanHistory(row) {
      let result = await this.common.reqBackState('/ssa/vscan/getVscanHistoryData.do', row, this);
      if(result.state) {
        this.vscanHistoryData = result.data;
        this.dialogTableVisible = true;
      }

    },
    refresh() {
      this.$store.dispatch('reloadTable', this.id);
    },
    filterType(value, row) {
      return row.type === value;
    },
    //默认的方法,基本无需修改
    handleEdit(i, row) {
      row.tableId = this.id;
      let arra = row.scanType.split('');
      let list = [arra[0]==='1'?'8':'0',arra[1]==='1'?'4':'0', arra[2]==='1'?'2':'0', arra[3]==='1'?'1':'0' ]
      row.scanTypeArray = [];
      list.forEach((l) => {
        if(l!=='0') {
          row.scanTypeArray.push(l);
        }
      })
      this.$router.push({name:'scanTaskForm', params:row })
      // this.$store.dispatch('handleEdit', [this.id, i, row]);
    },
    handleDelete(i, row) {
      this.$store.dispatch('handleDelete', [this, i, {"ids":[row.id]}]);
    },
    saveEdit(i, row) {
      if (this.objCheckNull(row, ["name", "mail|phone"]) && this.objCheck(row, ["mail", "phone"])) {
        this.$store.dispatch('saveEdit', [this, i, row]);
      }
    },
    cancelEdit() {
      this.$store.commit('cancelEdit', this.id);
    },
    //处理选中多选的row
    handleSelectionChange(selectedRow) {
      this.$store.commit('handleSelectionChange', [this.id, selectedRow]);
    },
    //处理翻页时候的事件
    handleCurrentChange(pageIndex) {
      this.$store.dispatch('handleCurrentChange', [this.id, pageIndex]);
    },
    //处理排序时候的事件
    handleSortChange(val) {
      this.$store.dispatch('handleSortChange', [this.id, val]);
    }
  },
  created: function() {
    var defConf = {
      total: 0,
      loading: false,
      tableData: [],
      pageSize: 10,
      pageIndex: 1,
      editRowIndex: -1,
      editRowTemp: {},
      multipleSelection: [],
      //默认ajax属性
      tableUrl: "/ssa/vscan/queryVScanTasksInfo.do",
      params: {},
      saveUrl: "/ssa/vscan/saveVScanTask.do",
      delUrl: "/ssa/vscan/deleteVScanTasks.do",
    };
    this.$store.commit('registerConf', [this.id, defConf]);
    this.defConf = this.$store.state.editTable[this.id];
    this.$store.dispatch('reloadTable', this.id);
  }

}
</script>

<style>

</style>
