<template>
<div class="">
  <div class="whitebackground Whitespace">
    <div class="top-title" v-if="!this.$route.params.id">新增扫描任务</div>
    <div class="top-title" v-if="this.$route.params.id">编辑扫描任务</div>

    <el-form :model="taskForm" :rules="rules" ref="taskForm" label-width="100px" class="form-contral">
      <el-form-item label="任务名称" prop="taskName" required>
        <el-input v-model="taskForm.taskName" style="width:391px;" placeholder="请输入3-30个字符" :disabled="taskForm.id?true:false"></el-input>
      </el-form-item>
      <el-form-item label="任务目标" prop="scanTarget" required>
        <el-input v-model="taskForm.scanTarget" style="width:391px;" placeholder="IP/URL"></el-input>
      </el-form-item>
      <el-form-item label="扫描类型" prop="scanType" required>
        <el-checkbox-group v-model="taskForm.scanTypeArray" @change="handleChange" >
          <el-checkbox label="8" :disabled="scanTypeStatus">Web扫描</el-checkbox>
          <el-checkbox label="4" :disabled="scanTypeStatus">主机扫描</el-checkbox>
          <el-checkbox label="2" :disabled="scanTypeStatus">端口扫描</el-checkbox>
          <el-checkbox label="1" :disabled="scanTypeStatus">弱密码扫描</el-checkbox>
        </el-checkbox-group>
      </el-form-item>
      <el-form-item label="扫描策略" prop="scanStrategy" required>
        <el-select v-model="taskForm.scanStrategy" style="width:391px;" @change="handleChange" :disabled="strategyEditStatus">
          <el-option label="快速扫描" :value="1"></el-option>
          <el-option label="完整扫描" :value="2"></el-option>
          <el-option label="子目录扫描" :value="3" v-show="subDirectoryShow"></el-option>
        </el-select>
      </el-form-item>
      <el-form-item label="执行频率" prop="frequency" required>
        <el-input v-model="taskForm.frequency" :disabled="true" placeholder="请设置cron表达式以确定执行频率" style="width:391px;"></el-input>
        <i class="el-icon-information cron-help" title="点击设置频率" id="buttonSet" @click="getCronHelp">设置</i>
        <easy-cron-input id="divCron" style="display: none"></easy-cron-input>
        <p id="pCron" style="display: none"> 频率解析: <span id="text"></span></p>
      </el-form-item>
      <el-form-item label="扫描协议" prop="scanProtocol">
        <el-select v-model="taskForm.scanProtocol" style="width:391px;" :disabled="protocolEditStatus">
          <!-- <el-option :label="u.userName" :value="u.userId" v-for="u in users"></el-option> -->
          <el-option label="HTTP" value="http"></el-option>
        </el-select>
      </el-form-item>
      <el-form-item label="子目录" prop="targetDirectory">
        <el-input v-model="taskForm.targetDirectory" :disabled="targetDirectoryEditStatus" placeholder="默认扫描所有子目录" style="width:391px;"></el-input>
      </el-form-item>
      <el-form-item label="扫描设备" prop="configId">
        <el-select v-model="taskForm.configId" style="width:391px;" :disabled="taskForm.id?true:false">
          <el-option :label="sd.name" :value="sd.id" v-for="sd in scanDevices"></el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" class="button-p-3" @click="submitForm('taskForm')">提交</el-button>
        <el-button type="gray" class="button-p-3" @click="resetForm('taskForm')">取消</el-button>
        <!-- <el-button type="gray" class="button-p-3" @click="clearSessionStorage">返回</el-button> -->
      </el-form-item>
      <!-- <div class="" v-if="this.$route.params.id">
            <el-form-item label="开始时间">
              <el-input v-model="taskForm.startTimestamp" style="width:300px;" ></el-input>
            </el-form-item>
            <el-form-item label="结束时间">
              <el-input v-model="taskForm.endTimestamp" style="width:300px;" ></el-input>
            </el-form-item>
            <el-form-item label="扫描状态">
              <el-input v-model="taskForm.status" style="width:300px;" ></el-input>
            </el-form-item>
          </div> -->

    </el-form>
  </div>

</div>
</template>

<script>
import { mapState } from 'vuex'
import utils from 'components/js/common.js'
export default {
  data() {
    let validateTaskName = (rule, value, callback) => {
      let pat = new RegExp("^([\\u4E00-\\u9FA5a-zA-Z0-9_-]{3,30})$");
      if (pat.test(value)) {
        callback();
      } else {
        callback(new Error('3-30个字符，支持英文、数字、"_-"的组合'));
      }
    };
    let validateScanTarget = (rule, value, callback) => {
      if (value.includes("-")) {
        let ipArra = value.split("-");
        let pat = /^((([1-9]|([1-9]\d)|(1\d\d)|(2([0-4]\d|5[0-5])))\.)(([0-9]|([1-9]\d)|(1\d\d)|(2([0-4]\d|5[0-5])))\.){2}([1-9]|([1-9]\d)|(1\d\d)|(2([0-4]\d|5[0-5])))((\-([1-9]|([1-9]\d)|(1\d\d)|(2([0-4]\d|5[0-5])))\.)(([0-9]|([1-9]\d)|(1\d\d)|(2([0-4]\d|5[0-5])))\.){2}([1-9]|([1-9]\d)|(1\d\d)|(2([0-4]\d|5[0-5]))))?)$|([^ ]+(?:[A-za-z0-9-]+\.)+[A-za-z]{2,4}(?:[\/\?#][\/=\?%\-&~`@[\]\':+!\.#\w]*)?)$/i;
        if (pat.test(ipArra[0]) && pat.test(ipArra[1])) {
          this.scanTypeStatus = true;
          this.taskForm.scanTypeArray = ['4'];
        }
      } else {
        this.scanTypeStatus = false;
        this.taskForm.scanTypeArray = [];
      }
      // let pat = /^((([1-9]|([1-9]\d)|(1\d\d)|(2([0-4]\d|5[0-5])))\.)(([0-9]|([1-9]\d)|(1\d\d)|(2([0-4]\d|5[0-5])))\.){2}([1-9]|([1-9]\d)|(1\d\d)|(2([0-4]\d|5[0-5])))((\-([1-9]|([1-9]\d)|(1\d\d)|(2([0-4]\d|5[0-5])))\.)(([0-9]|([1-9]\d)|(1\d\d)|(2([0-4]\d|5[0-5])))\.){2}([1-9]|([1-9]\d)|(1\d\d)|(2([0-4]\d|5[0-5]))))?)$|([^ ]+(?:[A-za-z0-9-]+\.)+[A-za-z]{2,4}(?:[\/\?#][\/=\?%\-&~`@[\]\':+!\.#\w]*)?)$/i;
      // if(pat.test(value)){
      //   callback();
      // }else {
      //   callback(new Error('2-60个字符，支持英文、数字、"_-."的组合'));
      // }
      callback();
    };
    let validateScanProtocol = (rule, value, callback) => {
      if (this.taskForm.scanType === '8') {
        if (!value && value !== '') {
          callback();
        } else {
          callback('请选择扫描协议');
        }
      } else {
        callback();
      }
      // let pat = new RegExp("^((http://)|(https://))?([\.%/\?\=\:a-zA-Z0-9_-]{2,60})$");
      // if(pat.test(value)){
      //   callback();
      // }else {
      //   callback(new Error('2-60个字符，支持英文、数字、"_-."的组合'));
      // }
    };
    let validateTargetDirectory = (rule, value, callback) => {
      if (this.taskForm.scanStrategy === 3 && value !== null && value !== '') {
        let pat = /^(((\/[a-z0-9A-Z-_]{1,})+)(\,)?)+$/;
        if (pat.test(value)) {
          callback();
        } else {
          callback(new Error('格式错误，请重新输入'));
        }
      } else {
        callback();
      }
    };

    return {
      taskForm: {
        id: '',
        taskName: '',
        scanTarget: '',
        scanStrategy: '',
        scanTypeArray: [],
        scanType: '',
        frequency: '',
        scanProtocol: 'http',
        targetDirectory: '',
        configId: ''
      },
      tableId: this.$route.params.tableId,
      strategys: [],
      types: [],
      protocols: [],
      scanTypeStatus: false,
      strategyEditStatus: false,
      targetDirectoryEditStatus: true,
      protocolEditStatus: true,
      subDirectoryShow: false,
      scanDevices: [],
      rules: {
        taskName: [{
            required: true,
            message: '请输入任务名称',
            trigger: 'blur'
          },
          {
            validator: validateTaskName,
            trigger: 'blur'
          }
        ],
        scanTarget: [{
            required: true,
            message: '请输入任务目标',
            trigger: 'blur'
          },
          {
            validator: validateScanTarget,
            trigger: 'blur'
          }
        ],
        scanStrategy: [{
          type: 'number',
          required: true,
          message: '请选择扫描策略',
          trigger: 'change'
        }],
        scanTypeArray: [{
          type: 'array',
          required: true,
          message: '请勾选扫描类型',
          trigger: 'blur'
        }],
        scanProtocol: [{
          required: true,
          validator: validateScanProtocol,
          trigger: 'blur'
        }],
        targetDirectory: [{
          required: true,
          validator: validateTargetDirectory,
          trigger: 'blur'
        }],
        configId: [{
          type: 'number',
          required: true,
          message: '请选择扫描设备',
          trigger: 'change'
        }]
      }
    };
  },
  computed: {
    // taskNameEdit: function() {
    //   return this.taskForm.id?true:false;
    // }
  },
  methods: {
    getCronHelp() {
      window.open('/static/cronboot/web/cronb/cron.htm');
    },
    submitForm(formName) {
      this.$refs[formName].validate(async (valid) => {
        if (valid) {
          this.assembleScanType();
          let data = await this.common.reqBackState('/ssa/vscan/saveVScanTask.do', this.taskForm, this);
          if (data.state) {
            this.clearSessionStorage();
            this.$message({
              type: 'success',
              message: data.message
            });
            this.$store.dispatch('reloadTable', this.tableId);
          } else {
            this.$message({
              type: 'error',
              message: data.message
            });
          }
        } else {
          console.log('error submit!!');
          return false;
        }
      });
    },
    getScanTypeString() {
      let typeList = this.taskForm.scanTypeArray;
      let typeString = "";
      typeList.forEach((t) => {
        typeString = typeString + t;
      })
      return typeString;
    },
    assembleScanType() {
      let typeString = this.getScanTypeString();
      let i8 = typeString.includes("8") ? "1" : "0";
      let i4 = typeString.includes("4") ? "1" : "0";
      let i2 = typeString.includes("2") ? "1" : "0";
      let i1 = typeString.includes("1") ? "1" : "0";
      this.taskForm.scanType = i8 + i4 + i2 + i1;
    },
    handleChange() {
      let typeString = this.getScanTypeString();
      this.targetDirectoryEditStatus = true;
      this.protocolEditStatus = true;

      if (typeString.includes("8")) {
        this.subDirectoryShow = true;
        if (this.taskForm.scanStrategy === 3) {
          this.protocolEditStatus = false;
          this.targetDirectoryEditStatus = false;
        }
      } else if (typeString.includes("4") || typeString.includes("2") || typeString.includes("1")) {
        this.taskForm.scanStrategy = 2;
        this.subDirectoryShow = false;
        // this.strategyEditStatus = false;

      } else {
        this.subDirectoryShow = true;
      }
    },
    clearSessionStorage() {
      // sessionStorage.clear();
      sessionStorage.removeItem('taskForm');
      this.$router.go(-1);
    },
    resetForm(formName) {
      this.$refs[formName].resetFields();
      this.clearSessionStorage();
    },
    async initDataList() {
      let sds = await this.common.req('/ssa/vscan/getVscanDevices.do', {}, this);
      this.scanDevices = sds;
      // console.log(this.scanDevices);
    },
    getCronHelp() {
      // window.open('/static/cronboot/web/cronb/cron.htm');
      document.getElementById("divCron").style.display = "block"; //显示
      document.getElementById("pCron").style.display = "block"; //显示
    },
  },
  created: function() {
    if (this.$route.params.id) {
      this.taskForm = this.$route.params;
      let assetInfo = JSON.stringify(this.$route.params);
      sessionStorage.taskForm = assetInfo;
    } else if (sessionStorage.taskForm) {
      this.taskForm = JSON.parse(sessionStorage.taskForm);
      this.$route.params.id = this.taskForm.id;
    }
    if (this.taskForm.id) {
      // this.strategyEditStatus = true;
      this.targetDirectoryEditStatus = true;
    } else {
      // this.strategyEditStatus = false;
      this.targetDirectoryEditStatus = true;
    }
    this.initDataList();
  },
  async mounted() {
    var el = document.getElementsByTagName('easy-cron-input')[0];
    var vm = this;
    el.addEventListener('input', function(e) {
      if (e.detail) {
        vm.taskForm.frequency = e.detail[0];
        document.querySelector('#text').textContent = e.detail[1];
      }
    })
    // console.log(this.$route.params);
    if (this.$route.params.id != undefined) {
      var result = await utils.reqBackState("/ssa/platformIntf_alarmIntf/cronData.do", this.$route.params, this);
      document.getElementById("pCron").style.display = "block"; //显示
      document.querySelector('#text').textContent = result.data;
    }
  },
  destroyed: function() {
    sessionStorage.removeItem('taskForm');
  }
}
</script>

<style>
.cron-help {
  padding: 3px;
  margin-left: 5px;
  color: #4db3ff;
  font-size: 18px;
  vertical-align: middle;
  cursor: pointer;
}
</style>
