<template>
<div class="el-panel-bigscreen">
  <div class="el-panel-bigscreen-heading">
    <h3 class="el-panel-bigscreen-title"><i class="el-icon-caret-right title-symbol"></i>漏洞影响范围</h3>
  </div>
  <div class="el-panel-bigscreen-body">
    <div class="box">
      <span class="box-tl"></span>
      <span class="box-br"></span>
      <div class="echartsmapbox2" id="vulnerabilitymap"></div>
    </div>
  </div>
</div>
</template>

<script>
import echarts from 'echarts'
import {mapState} from 'vuex'
export default {
  computed: {
    ...mapState({
      activeScreen: state => state.context.activeScreen
    })
  },
  watch: {
    activeScreen: function() {
      if(this.activeScreen===3) {
        this.loadMapChart();
      }
    }
  },
  methods: {
    loadMapChart() {
      let myChart = echarts.init(document.getElementById('vulnerabilitymap'));
      let option = {
        //	 backgroundColor:'#0b182a',
        tooltip: {
          trigger: 'item',
          formatter: '{b}:{c}'
        },
        visualMap: {
          seriesIndex: 0,
          min: 0,
          max: 200,
          left: 10,
          top: 'bottom',
          bottom: '5%',
          color: ['#e2dede', '#e07f6f', '#e02908'],
          text: ['多', '少'], // 文本，默认为数值文本
          textStyle: {
            color: '#fff'
          },
          calculable: true
        },
        grid: {
          height: 300,
          width: 10,
          right: 120,
          bottom: 10
        },
        xAxis: {
          type: 'category',
          data: [],
          splitNumber: 1,
          show: false
        },
        yAxis: {
          position: 'right',
          min: 0,
          max: 20,
          splitNumber: 20,
          inverse: true,
          axisLabel: {
            show: true,
            margin: 20,
            textStyle: {
              color: '#fff'
            }
          },
          axisLine: {
            show: false
          },
          splitLine: {
            show: false
          },
          axisTick: {
            show: false
          },
          data: []
        },
        series: [{
            zlevel: 1,
            name: '太原',
            type: 'map',
            mapType: 'taiyuan',
            selectedMode: 'multiple',
            roam: true,
            zoom: 1,
            top: '5%',
            bottom: '5%',
            left: '10%',
            right: '10%',
            label: {
              normal: {
                show: false
              },
              emphasis: {
                show: true
              }
            },
            itemStyle: {
              normal: {
                borderWidth: 1,
                borderColor: '#0c1c33'
              }
            },
            data: [{
                name: '尖草坪区',
                value: 78
              },
              {
                name: '万柏林区',
                value: 89
              },
              {
                name: '迎泽区',
                value: 120
              },
              {
                name: '小店区',
                value: 56
              },
              {
                name: '杏花岭区',
                value: 100
              },
              {
                name: '晋源区',
                value: 67
              },
              {
                name: '清徐县',
                value: 39
              },
              {
                name: '古交市',
                value: 8
              },
              {
                name: '娄烦县',
                value: 19
              },
              {
                name: '阳曲县',
                value: 23
              }
            ]
          },
          {
            zlevel: 2,
            name: '地图指示',
            type: 'bar',
            barWidth: 15,
            itemStyle: {
              normal: {
                color: undefined,
                shadowColor: 'rgba(0, 0, 0, 0.1)',
                shadowBlur: 10
              }
            },
            data: [20]
          }
        ]
      };
      myChart.setOption(option);
      window.onresize = myChart.resize;

      let self = this;
      setTimeout(function() {
        let TOPN = 10

        let option = myChart.getOption()
        // 修改top
        option.grid[0].height = TOPN * 20
        option.yAxis[0].max = TOPN
        option.yAxis[0].splitNumber = TOPN
        option.series[1].data[0] = TOPN
        // 排序
        let data = option.series[0].data.sort(function(a, b) {
          return b.value - a.value
        })

        let maxValue = data[0].value,
          minValue = data.length > TOPN ? data[TOPN - 1].value : data[data.length - 1].value

        let s = option.visualMap[0].controller.inRange.color[0],
          e = option.visualMap[0].controller.inRange.color.slice(-1)[0]
        let sColor = self.getGradientColor(s, e, maxValue, minValue)
        let eColor = self.getGradientColor(s, e, maxValue, maxValue)

        //	option.visualMap.max = maxValue

        option.series[1].itemStyle.normal.color = new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
          offset: 1,
          color: sColor
        }, {
          offset: 0,
          color: eColor
        }])

        // yAxis
        let newYAxisArr = []
        echarts.util.each(data, function(item, i) {
          if (i >= TOPN) {
            return false
          }
          let c = self.getGradientColor(sColor, eColor, maxValue, item.value)
          newYAxisArr.push({
            value: item.name,
            textStyle: {
              // color: c
              color: '#fff' //字体颜色
            }
          })
        })
        option.yAxis[0].data = newYAxisArr
        option.yAxis[0].axisLabel.formatter = (function(data) {
          return function(value, i) {
            if (!value) return ''
            return value + ' ' + data[i].value
          }
        })(data)
        myChart.setOption(option)
      }, 0);
      window.onresize = myChart.resize;
    },
    getGradientColor(start, end, max, val) {
      let rgb = /#((?:[0-9]|[a-fA-F]){2})((?:[0-9]|[a-fA-F]){2})((?:[0-9]|[a-fA-F]){2})/;
      let sM = start.match(rgb);
      let eM = end.match(rgb);
      let err = '';
      max = max || 1
      val = val || 0
      if (sM === null) {
        err = 'start';
      }
      if (eM === null) {
        err = 'end';
      }
      if (err.length > 0) {
        throw new Error('Invalid ' + err + ' color format, required hex color');
      }
      let sR = parseInt(sM[1], 16),
        sG = parseInt(sM[2], 16),
        sB = parseInt(sM[3], 16);
      let eR = parseInt(eM[1], 16),
        eG = parseInt(eM[2], 16),
        eB = parseInt(eM[3], 16);
      let p = val / max;
      let gR = Math.round(sR + (eR - sR) * p).toString(16),
        gG = Math.round(sG + (eG - sG) * p).toString(16),
        gB = Math.round(sB + (eB - sB) * p).toString(16);
      return '#' + gR + gG + gB;
    }
  },
  mounted: function() {
    // this.loadMapChart();
  }
}
</script>

<style lang="css">
</style>
