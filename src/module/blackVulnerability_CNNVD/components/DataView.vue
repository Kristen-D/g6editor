<template>
<div>

  <section class="content">
  <div class="container-fluid">
    <el-row>
      <el-col span="10">
        <el-breadcrumb separator-class="el-icon-arrow-right" class="top-breadcrumb" >
          <el-breadcrumb-item :to="{ path: '/' }">漏洞</el-breadcrumb-item>
          <el-breadcrumb-item>CNNVD漏洞 </el-breadcrumb-item>
        </el-breadcrumb>
      </el-col>
      <el-col span="8">
          <el-button type="text"  >CNNVD漏洞数量：{{cnnvdData}}</el-button>
      </el-col>
      <el-col span="4">
          <el-button type="text" @click="showTotal()" >近一周每天的漏洞更新数量</el-button>
      </el-col>
    </el-row>
    <div class="el-panel">
      <span class="left-top"></span><span class="left-bottom"></span>
      <span class="right-top"></span><span class="right-bottom"></span>
      <div class="el-panel-body shine">
        <div style="position: relative">
          <el-form :model="params"  ref="params" :inline="true" class="demo-form-inline elform" label-width="62px">

            <!-- 普通搜索 -->
            <div v-if="!advancedFlag" style="display:inline-block;">
              <el-form-item label="" prop="attribute" class="test">
                <el-select v-model="params.attribute" clearable placeholder="选择属性" size="mini">
                  <el-option v-for="item in attributes" :key="item.value" :label="item.label" :value="item.value"></el-option>
                </el-select>
              </el-form-item>
              <el-form-item label="">
                <el-input size="mini" style="width:220px" v-if="params.attribute===''" placeholder="属性值"></el-input>
                <el-input size="mini" style="width:220px" v-if="params.attribute==='title'" v-model="params.title" placeholder="漏洞值"></el-input>
                <el-input size="mini" style="width:220px" v-if="params.attribute==='cveid'" v-model="params.cveid" placeholder="CVE编号"></el-input>
                <el-input size="mini" style="width:220px" v-if="params.attribute==='cnnvd_id'" v-model="params.cnnvd_id" placeholder="CNNVD编号"></el-input>
                <el-input size="mini" style="width:220px" v-if="params.attribute==='source'" v-model="params.source" placeholder="来源值"></el-input>
                <el-input size="mini" style="width:220px" v-if="params.attribute==='type'" v-model="params.type" placeholder="类型值"></el-input>
                <el-select size="mini" style="width:220px" clearable v-if="params.attribute==='level'" v-model="params.level" clearable placeholder="选择等级值">
                  <el-option v-for="item in levels" :key="item.value" :label="item.label" :value="item.value">
                  </el-option>
                </el-select>
                <el-select size="mini" style="width:220px" clearable v-if="params.attribute==='edb_verified'" v-model="params.edb_verified" clearable placeholder="选择属性值">
                  <el-option v-for="item in edb_verifieds" :key="item.value" :label="item.label" :value="item.value">
                  </el-option>
                </el-select>
                <el-date-picker size="mini" v-if="params.attribute==='collect_date'" type="date" style="width:320px" v-model="params.collect_date" clearable placeholder="选择采集时间值">
                </el-date-picker>

              </el-form-item>
              <el-form-item prop="attribute">
                <el-button type="deepblue" size="mini" @click="search">搜索</el-button>

              </el-form-item>

              <el-button type="text" class="btn-search " @click="ShowAdvancedSearch()">高级搜索
                <i class="el-icon-caret-bottom m-l-6"></i>
              </el-button>

            </div>

            <!-- 高级搜索 -->
            <div v-if="advancedFlag">
              <el-form-item label="漏洞名称" class="test" style="width:282px" key='title'>
                <el-input placeholder="漏洞名称" size="mini" v-model="params.title" style="width:220px"></el-input>
              </el-form-item>
              <el-form-item label="CVE" style="width:282px" key='cveid'>
                <el-input placeholder="CVE编号" size="mini" v-model="params.cveid" style="width:220px"></el-input>
              </el-form-item>

              <el-form-item label="CNNVD" style="width:282px" key='cnnvd'>
                <el-input placeholder="CNNVD编号" size="mini" v-model="params.cnnvd_id" style="width:220px"></el-input>
              </el-form-item>
              <el-form-item label="来源" style="width:282px" key='source'>
                <el-input placeholder="来源" size="mini" v-model="params.source" style="width:220px"></el-input>
              </el-form-item>
              <el-form-item label="类型" style="width:282px" key='type'>
                <el-input placeholder="类型" size="mini" v-model="params.type" style="width:220px"></el-input>
              </el-form-item>
              <el-form-item label="严重程度" class="test" style="width:282px" key='level'>
                <el-select placeholder="严重程度" size="mini" clearable style="width:220px" v-model="params.level">
                  <el-option v-for="item in levels" :key="item.value" :label="item.label" :value="item.value">
                  </el-option>
                </el-select>
              </el-form-item>

              <el-form-item label="采集时间" class="test" style="width:282px" key='collect_date'>
                <el-date-picker size="mini" v-model="params.collect_date" type="date" style="width:220px" placeholder="采集时间">
                </el-date-picker>
              </el-form-item>
              <br>
              <el-form-item style="display:flex;justify-content:center">
                <el-button type="deepblue" @click="search" size="mini">搜索</el-button>
                <el-button type="deepblue" size="mini" @click="resetForm">清空</el-button>
              </el-form-item>
              <el-button type="text" class="btn-search btn-search-advance" @click="ShowCommonSearch()">普通搜索
                <i class="el-icon-caret-top m-l-6"></i>
              </el-button>

            </div>
          </el-form>
          </el-form>
        </div>

        <blackVulnerabilityTable :checkList="attributes" :id="tableId"></blackVulnerabilityTable>
      </div>
    </div>
  </div>
</section>
<el-dialog title="漏洞统计页面" :visible.sync="infoDialogShow" :show-close="true"    class="dialog-panel  bounceIn">
       <div class="el-panel-body shine">
            <totalPage></totalPage>
       </div>
  </el-dialog>
</div>
</template>
<script>
import blackVulnerabilityTable from './BlackVulnerabilityTable.vue'
import totalPage from './TotalPage.vue'
export default {
  components: {
    totalPage,
    blackVulnerabilityTable,
  },
  data() {

    return {
      tableId: 'blackVULInfoTable',
      advancedFlag: false,
      infoDialogShow:false,
      cnnvdData:"",
      sources: [],
      params: {
        attribute: "",
        title: "", //漏洞
        cveid: "", //cve编号
        source: "", //来源
        type: "", //类型
        level: "", //严重程度
        edb_verified: "", //是否验证
        collect_date: "" ,//采集时间
        cnnvd_id:""//CNNVD编号
      },
      attributes: [{
          value: 'title',
          label: '漏洞'
        },
        {
          value: 'cveid',
          label: 'CVE编号'
        },
        {
          value: 'source',
          label: '来源'
        },
        {
          value: 'type',
          label: '类型'
        },
        {
          value: 'level',
          label: '严重程度'
        },

        {
          value: 'collect_date',
          label: '采集时间'
        },
        {
          value: 'cnnvd_id',
          label: 'CNNVD编号'
        },
      ],
      levels:[
        {
          value:"低危",
          label: "低危"
        },
        {
          value: "中危",
          label: "中危"
        },
        {
          value: "高危",
          label: "高危"
        },{
          value: "超危",
          label: "超危"
        }
      ],
      types: [{
        value: 0,
        label: "手动输入"
      }, {
        value: 1,
        label: "验证输入"
      }],
      severitys: [{
          value: 1,
          label: '低'
        },
        {
          value: 2,
          label: '中'
        },
        {
          value: 3,
          label: '高'
        },
        {
          value: 4,
          label: '极高'
        },
      ]
    }; //return 结束
  }, //data结束

  methods: {
    // 清空输入框
    resetForm(formName) {
      this.params = {
        attribute: "",
        title: "", //漏洞
        cveid: "", //cve编号
        source: "", //来源
        type: "", //类型
        level: "", //严重程度
        edb_verified: "", //是否验证
        collect_date: "" ,//采集时间
        cnnvd_id:""//CNNVD编号
      };

    },
    showTotal(){
      this.infoDialogShow=true;
    },
    // 高级搜索
    ShowAdvancedSearch() {
      this.advancedFlag = true;
    },
    // 普通搜索
    ShowCommonSearch() {
      this.resetForm('params');
      this.advancedFlag = false;
    },
    // 搜索
    search() {
      if (this.params.collect_date != null && this.params.collect_date != '') {
        this.params.collect_date = this.common.formatDate(this.params.collect_date);
      }
      this.$store.commit("setParams", [this.tableId, this.params]);
      this.$store.dispatch("reloadTable", this.tableId);

    },
    async initDataList() {
      let data = await this.common.req('/ssa/vulnerability/getCnnvdTotalCount.do', {}, this);
      this.cnnvdData = data.value;
    }

  },
  created: async function() {
    this.initDataList();
  }
}
</script>
<style media="screen">
.btn-search-advance {
  bottom: 0;
}
.el-dialog {

     margin: 0 ;

}
.top-breadcrumb {
  line-height: 40px;
  margin: 0;
}
</style>
