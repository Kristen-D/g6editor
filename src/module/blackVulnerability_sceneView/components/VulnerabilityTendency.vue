<template>
<div>
  <div class="el-panel">

    <span class="left-top"></span><span class="left-bottom"></span>
    <span class="right-top"></span><span class="right-bottom"></span>
    <div class="shine">
      <div class="" style="height: 60px; padding: 10px 30px;">
        <el-tabs v-model="tendencyType" class="labeltabs">
          <!--
          <el-tab-pane @click="changeTendency(1)" label="采集趋势" name="first"></el-tab-pane>
          <el-tab-pane @click="changeTendency(2)" label="更新趋势" name="second"></el-tab-pane>
         -->
          <el-tab-pane  label="发布趋势" name="publish_time"></el-tab-pane>
          <el-tab-pane  label="采集趋势" name="collect_date"></el-tab-pane>

        </el-tabs>
        <el-radio-group v-model="dateRange"  class="daytabs m-t--45">
          <el-radio-button label="week">近7天</el-radio-button>
          <el-radio-button label="month">近30天</el-radio-button>
        </el-radio-group>
      </div>
      <div class="echartsbox7" ref="line1" id="line1"></div>
      <div class="text-center" ref="clickShow" style="margin:50px 40px;display:none">
        <h4 class="el-subtitle">采集类型
          <!-- 采集趋势-近24小时-13:00 -->
          <span class="float-r"><i class="fa fa-bars m-r-8" ></i>列表</span>
        </h4>
      </div>
      <div class="echartsbox9" ref="line2" id="line2"></div>
    </div>
  </div>
</div>
</template>
<script>


export default {
  data() {
    return {
      dateRange:"week",
      tendencyType:"publish_time",
      categoryData:[],
      tendencyData:[],
      vulnerabilityTypeData:[],
      dateTime:"",
      typeCategoryData:[],
      typeValueData:[]
    }
  },
  watch:{
    tendencyType: async function(val, oldVal){
      await this.getTendencyData();

    },
    dateRange:async function(val, oldVal){
      await this.getTendencyData();

    },
  },
  methods: {
    loadLine1Chart() {
      var myChart3 = echarts.init(document.getElementById('line1'));
      var linecolor = {
        show: true,
        lineStyle: {
          color: '#17334e'
        }
      };

      var option3 = {
        tooltip: {
          trigger: 'axis',
          position: function(point, params, dom, rect, size) {
            // 鼠标右上
            return [point[0] - 200, point[1] - 90];
          },
          axisPointer: {
            type: 'line', //灰色指示线
            lineStyle: {
              color: 'gray'
            }
          },
          formatter: function(params) {

              var res = "";
              var value = params[0].value;
              var name = params[0].axisValue;
              res = "<p>时间："
                  + name+ "</p><p>数量："
                  + value+ "</p>";
              return res;
          },

          backgroundColor: 'rgba(0,0,0,0.85)',
          padding: [10, 10],
          textStyle: {
            fontSize: 14,
            color: '#fff',
          },

          extraCssText: 'border-top:6px solid #0066cc;border-radius:0;'
        },
        grid: {
          left: '2%',
          right: '2%',
          top: '6%',
          bottom: '5%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          name: '',
          splitLine: linecolor,
          axisTick: {
            show: false
          },
          axisLine: linecolor,
          axisLabel: {
            color: '#47a8f1'
          },
          data: this.categoryData
        },
        yAxis: {
          type: 'value',

          name: '',
          axisTick: {
            show: false
          },
          axisLine: linecolor,
          splitLine: linecolor,
          axisLabel: {
            color: '#47a8f1'
          },


        },
        series: [{
          name: '3的指数',
          type: 'line',
          lineStyle: {
            normal: {
              color: '#3ea9f4',
              width: 2
            }
          },
          smooth: true,
          symbol: 'image://http://localhost:8080/static/images/wxqb/echarts-line.png',
          symbolSize: 10,
          showSymbol: false,
          data: this.tendencyData
        }, ]
      };
      myChart3.setOption(option3);
      window.onresize = myChart3.resize();

      let vm = this;
      //防止多次注册
      myChart3.off('click');
      myChart3.on('click', function(params) {
        vm.dateTime = params.name;
        vm.$refs.clickShow.style.display = "block";
        vm.getTendencyTypeDataByDate();
      });
    },

    loadLine2Chart(data) {
      var linecolor = {
        show: true,
        lineStyle: {
          color: '#17334e'
        }
      };
      var option4 = {
        tooltip: {
          trigger: 'axis',
          position: function(point, params, dom, rect, size) {
            return [point[0] - 200, point[1] - 90];
          },
          axisPointer: {
            type: 'line',
            lineStyle: {
              color: 'gray'
            }
          },
          backgroundColor: 'rgba(0,0,0,0.85)',
          padding: [10, 10],
          textStyle: {
            fontSize: 14,
            color: '#fff',
          },

          extraCssText: 'border-top:6px solid #0066cc;border-radius:0;'
        },
        grid: {
          left: '2%',
          right: '2%',
          top: '2%',
          bottom: '23%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          name: '',
          splitLine: linecolor,
          axisTick: {
            show: false
          },
          axisLine: linecolor,
          axisLabel: {
            color: '#47a8f1'
          },
          data:this.typeCategoryData
        },
        yAxis: {
          type: 'value',
          name: '',
          axisTick: {
            show: false
          },
          axisLine: linecolor,
          splitLine: linecolor,
          axisLabel: {
            color: '#47a8f1'
          }



        },
        dataZoom: [{
            show: true,
            height: 30,
            xAxisIndex: [0],
            bottom: '8%',
            left: '4%',
            right: '5%',
            type: 'slider',
            start: 0,
            end: 100,
            borderColor: 'transparent',
            fillerColor: 'transparent',
            handleStyle: {
              color: '#00eaff'
            },
            dataBackground: {
              lineStyle: {
                color: '#00eaff',
                opacity: 0.7
              },
              areaStyle: {
                color: '#00eaff',
                opacity: 0.7
              }
            },
            textStyle: {
              color: '#ff0000'
            }
          },
          {
            show: true,
            type: 'inside',
            height: 15,

            start: 0,
            end: 100
          }
        ],
        series: [{

          type: 'bar',
          lineStyle: {
            normal: {
              color: '#3ea9f4',
              width: 2
            }
          },
          symbol: 'image://http://localhost:8080/static/images/wxqb/echarts-line.png',
          symbolSize: 10,
          showSymbol: false,
          data:this.typeValueData
        }]
      };
      var myChart4 = echarts.init(document.getElementById('line2'));
      myChart4.setOption(option4);
      window.onresize = myChart4.resize();
    },
    //查询趋势
  async  getTendencyData(){
      var  params = {tendencyType:this.tendencyType,dateRange:this.dateRange};
      var data = await  this.common.req("/ssa/vulnerability/getVulnerabilityGroupByDate.do",params);
      this.categoryData = data.date;
      this.tendencyData = data.data;

      this.loadLine1Chart();
    },
  //根据日期 按漏洞类型分类展示
  async  getTendencyTypeDataByDate(){
      var  params = {tendencyType:this.tendencyType,dateTime:this.dateTime};
      var data = await  this.common.req("/ssa/vulnerability/getVulnerabilityGroupByType.do",params);
      var seriesData=[];
      this.typeCategoryData=[];
      this.typeValueData=[];

      for(var i = 0; i < data.typeList.length; i++){
        var dataUnit = data.typeList[i];
          var list=[];
          this.typeCategoryData.push(dataUnit.name);
          this.typeValueData.push(dataUnit.value);
      };

        this.loadLine2Chart();
    }

  },
  mounted: async function() {
    await this.getTendencyData();

  }
}
</script>
